/**
 * Re-request an expired consultation (free for patient)
 * @route POST /api/consultations/:id/re-request
 * @access Private (Patient only)
 */
exports.reRequestConsultation = async (req, res) => {
    try {
        const consultationId = req.params.id;
        const userId = req.user.id;

        // Get original consultation
        const originalConsultation = await Consultation.findById(consultationId);

        if (!originalConsultation) {
            return res.status(404).json({
                success: false,
                message: 'Consultation not found'
            });
        }

        // Verify user is the patient
        if (originalConsultation.patientId.toString() !== userId) {
            return res.status(403).json({
                success: false,
                message: 'Only the patient can re-request a consultation'
            });
        }

        // Verify consultation is expired (not permanently)
        if (originalConsultation.expiryStage !== 'expired') {
            return res.status(400).json({
                success: false,
                message: 'Only expired consultations can be re-requested'
            });
        }

        // Create new consultation with same details (free re-request)
        const newConsultation = await Consultation.create({
            patientId: originalConsultation.patientId,
            doctorId: originalConsultation.doctorId,
            doctorName: originalConsultation.doctorName,
            specialty: originalConsultation.specialty,
            doctorImage: originalConsultation.doctorImage,
            date: originalConsultation.date,
            time: originalConsultation.time,
            type: originalConsultation.type,
            status: 'upcoming', // Back to pending approval
            fee: originalConsultation.fee,
            reason: originalConsultation.reason,
            paymentStatus: 'paid', // Already paid from original
            paymentMethod: originalConsultation.paymentMethod,
            isReRequest: true,
            originalConsultationId: originalConsultation._id
        });

        res.status(201).json({
            success: true,
            message: 'Consultation re-requested successfully',
            data: newConsultation
        });
    } catch (error) {
        console.error('Error re-requesting consultation:', error);
        res.status(500).json({
            success: false,
            message: 'Server error',
            error: error.message
        });
    }
};
